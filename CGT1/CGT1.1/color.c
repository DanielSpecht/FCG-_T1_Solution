/*  Departamento de Informatica, PUC-Rio, INF1761 Computer Graphhics
*
*   @file color.h TAD: Generic colorimetry computarioms (implementation).
*   @author Marcelo Gattass and others
*
*   @date
*         Last version:     06/2014.
*
*   @version 4.0
*
*   @Copyright/License
*   DI PUC-Rio Educational Software
*   All the products under this license are free software: they can be used for both academic and commercial purposes at absolutely no cost.
*   There are no paperwork, no royalties, no GNU-like "copyleft" restrictions, either. Just download and use it.
*   They are licensed under the terms of the MIT license reproduced below, and so are compatible with GPL and also qualifies as Open Source software.
*   They are not in the public domain, PUC-Rio keeps their copyright. The legal details are below.
*
*   The spirit of this license is that you are free to use the libraries for any purpose at no cost without having to ask us.
*   The only requirement is that if you do use them, then you should give us credit by including the copyright notice below somewhere in your product or its documentation.
*
*   Copyright © 2010-2014 DI PUC-Rio Educational Software
*
*   Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software
*   without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sub license, and/or sell copies of the Software, and to permit
*   persons to whom the Software is furnished to do so, subject to the following conditions:
*
*   The above copyright notice and this permission notice shall be included in all copies or suavlantial portions of the Software.
*
*   THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
*   FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
*   WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
*
*/

#include <stdio.h>
#include <stdlib.h>
#include<assert.h>
#include<math.h>
#include <float.h>

#include "color.h"

#define RAD2DEG(xX) (180.0f/3.14159265358979f * (xX))
#define DEG2RAD(xX) (3.14159265358979f/180.0f * (xX))

/* COLOR CONSTANT DATA */

/*  Reference white CIEXYZ values for 2 degrees observer CIE 1931 */
const float reference_white[n_illuminants][3] = {
	/* A  */{ 1.09850f,  1.0f, 0.35585f },
	/* C  */{ 0.98074f,  1.0f, 1.18232f },
	/* D50 */{ 0.96422f,  1.0f, 0.82521f },
	/* D55 */{ 0.95682f,  1.0f, 0.92149f },
	/* D65 */{ 0.95047f,  1.0f, 1.08883f },
	/* D75 */{ 0.94972f,  1.0f, 1.22638f },
	/* F2 */{ 0.99187f,  1.0f, 0.67395f },
	/* F7 */{ 0.95044f,  1.0f, 1.08755f },
	/* F11 */{ 1.00966f,  1.0f, 0.64370f },
	/* test*/{ 1.00000f,  1.0f, 1.00000f } };

/* Standard monitor */
struct BT709 {
	float r[2];
	float g[2];
	float b[2];
	float w[2];
} monitor = { { 0.64f,0.33f },{ 0.30f, 0.60f },{ 0.15f,0.06f },{ 0.3127f,0.3290f } };


/* spectral values for 2 degrees observer CIE 1931 (x_bar,y_bar,z_bar) and illuminants A, D50, D55, D65, D75 and C  */
const struct CIEXYZ_A_D65_spectrum { float lambda, x_bar, y_bar, z_bar, A, D50, D55, D65, D75, C; } spec[401] = {
	{ 380,0.00000f,0.00000f,0.00000f,0.10542f,0.24488f,0.32584f,0.48032f,0.66703f,0.33000f },
	{ 381,0.00150f,0.00004f,0.00708f,0.10773f,0.25026f,0.33134f,0.48481f,0.67029f,0.34384f },
	{ 382,0.00164f,0.00005f,0.00775f,0.11008f,0.25564f,0.33684f,0.48930f,0.67355f,0.35768f },
	{ 383,0.00180f,0.00005f,0.00850f,0.11245f,0.26103f,0.34235f,0.49379f,0.67681f,0.37152f },
	{ 384,0.00200f,0.00006f,0.00941f,0.11486f,0.26641f,0.34785f,0.49829f,0.68007f,0.38536f },
	{ 385,0.00224f,0.00006f,0.01055f,0.11731f,0.27179f,0.35335f,0.50278f,0.68333f,0.39920f },
	{ 386,0.00254f,0.00007f,0.01197f,0.11979f,0.27717f,0.35885f,0.50727f,0.68659f,0.41416f },
	{ 387,0.00289f,0.00008f,0.01366f,0.12231f,0.28256f,0.36436f,0.51176f,0.68985f,0.42912f },
	{ 388,0.00330f,0.00009f,0.01559f,0.12486f,0.28794f,0.36986f,0.51625f,0.69311f,0.44408f },
	{ 389,0.00375f,0.00011f,0.01773f,0.12745f,0.29333f,0.37537f,0.52074f,0.69637f,0.45904f },
	{ 390,0.00424f,0.00012f,0.02005f,0.13007f,0.29871f,0.38087f,0.52523f,0.69963f,0.47400f },
	{ 391,0.00476f,0.00013f,0.02251f,0.13273f,0.31815f,0.40373f,0.55225f,0.73160f,0.48954f },
	{ 392,0.00533f,0.00015f,0.02520f,0.13543f,0.33758f,0.42659f,0.57926f,0.76356f,0.50508f },
	{ 393,0.00598f,0.00017f,0.02828f,0.13816f,0.35702f,0.44946f,0.60627f,0.79553f,0.52062f },
	{ 394,0.00674f,0.00019f,0.03190f,0.14093f,0.37645f,0.47232f,0.63329f,0.82749f,0.53616f },
	{ 395,0.00765f,0.00022f,0.03621f,0.14373f,0.39589f,0.49518f,0.66030f,0.85946f,0.55170f },
	{ 396,0.00875f,0.00025f,0.04144f,0.14657f,0.41533f,0.51804f,0.68731f,0.89143f,0.56796f },
	{ 397,0.01003f,0.00028f,0.04750f,0.14945f,0.43477f,0.54090f,0.71433f,0.92339f,0.58422f },
	{ 398,0.01142f,0.00032f,0.05412f,0.15236f,0.45420f,0.56377f,0.74134f,0.95536f,0.60048f },
	{ 399,0.01287f,0.00036f,0.06100f,0.15531f,0.47364f,0.58663f,0.76835f,0.98732f,0.61674f },
	{ 400,0.01431f,0.00040f,0.06785f,0.15830f,0.49308f,0.60949f,0.79537f,1.01929f,0.63300f },
	{ 401,0.01570f,0.00043f,0.07449f,0.16133f,0.50028f,0.61709f,0.80376f,1.02925f,0.65002f },
	{ 402,0.01715f,0.00047f,0.08136f,0.16439f,0.50749f,0.62470f,0.81215f,1.03922f,0.66704f },
	{ 403,0.01878f,0.00052f,0.08915f,0.16749f,0.51469f,0.63230f,0.82054f,1.04918f,0.68406f },
	{ 404,0.02075f,0.00057f,0.09854f,0.17062f,0.52190f,0.63991f,0.82893f,1.05915f,0.70108f },
	{ 405,0.02319f,0.00064f,0.11020f,0.17380f,0.52910f,0.64751f,0.83733f,1.06911f,0.71810f },
	{ 406,0.02621f,0.00072f,0.12461f,0.17701f,0.53631f,0.65512f,0.84572f,1.07908f,0.73568f },
	{ 407,0.02978f,0.00083f,0.14170f,0.18026f,0.54351f,0.66272f,0.85411f,1.08904f,0.75326f },
	{ 408,0.03388f,0.00094f,0.16130f,0.18355f,0.55072f,0.67033f,0.86250f,1.09901f,0.77084f },
	{ 409,0.03847f,0.00107f,0.18326f,0.18687f,0.55792f,0.67793f,0.87089f,1.10897f,0.78842f },
	{ 410,0.04351f,0.00121f,0.20740f,0.19024f,0.56513f,0.68554f,0.87928f,1.11894f,0.80600f },
	{ 411,0.04900f,0.00136f,0.23369f,0.19364f,0.56865f,0.68856f,0.88115f,1.11984f,0.82386f },
	{ 412,0.05502f,0.00153f,0.26261f,0.19708f,0.57217f,0.69158f,0.88302f,1.12075f,0.84172f },
	{ 413,0.06172f,0.00172f,0.29477f,0.20055f,0.57569f,0.69461f,0.88489f,1.12165f,0.85958f },
	{ 414,0.06921f,0.00194f,0.33080f,0.20407f,0.57921f,0.69763f,0.88676f,1.12256f,0.87744f },
	{ 415,0.07763f,0.00218f,0.37130f,0.20762f,0.58273f,0.70065f,0.88863f,1.12346f,0.89530f },
	{ 416,0.08696f,0.00245f,0.41621f,0.21121f,0.58625f,0.70367f,0.89051f,1.12436f,0.91244f },
	{ 417,0.09718f,0.00276f,0.46546f,0.21485f,0.58977f,0.70670f,0.89238f,1.12527f,0.92958f },
	{ 418,0.10841f,0.00312f,0.51969f,0.21851f,0.59330f,0.70972f,0.89424f,1.12617f,0.94672f },
	{ 419,0.12077f,0.00353f,0.57953f,0.22222f,0.59682f,0.71275f,0.89612f,1.12708f,0.96386f },
	{ 420,0.13438f,0.00400f,0.64560f,0.22597f,0.60034f,0.71577f,0.89799f,1.12798f,0.98100f },
	{ 421,0.14936f,0.00455f,0.71848f,0.22975f,0.59812f,0.71211f,0.89150f,1.11827f,0.99640f },
	{ 422,0.16540f,0.00516f,0.79671f,0.23357f,0.59591f,0.70845f,0.88501f,1.10857f,1.01180f },
	{ 423,0.18198f,0.00583f,0.87785f,0.23743f,0.59369f,0.70478f,0.87852f,1.09886f,1.02720f },
	{ 424,0.19861f,0.00655f,0.95944f,0.24133f,0.59148f,0.70112f,0.87204f,1.08916f,1.04260f },
	{ 425,0.21477f,0.00730f,1.03905f,0.24527f,0.58926f,0.69746f,0.86555f,1.07945f,1.05800f },
	{ 426,0.23019f,0.00809f,1.11537f,0.24924f,0.58704f,0.69380f,0.85906f,1.06974f,1.07120f },
	{ 427,0.24488f,0.00891f,1.18850f,0.25326f,0.58483f,0.69013f,0.85258f,1.06004f,1.08440f },
	{ 428,0.25878f,0.00977f,1.25812f,0.25731f,0.58261f,0.68647f,0.84609f,1.05033f,1.09760f },
	{ 429,0.27181f,0.01066f,1.32393f,0.26140f,0.58040f,0.68280f,0.83960f,1.04063f,1.11080f },
	{ 430,0.28390f,0.01160f,1.38560f,0.26553f,0.57818f,0.67914f,0.83312f,1.03092f,1.12400f },
	{ 431,0.29494f,0.01257f,1.44264f,0.26970f,0.59519f,0.69683f,0.85059f,1.04903f,1.13470f },
	{ 432,0.30490f,0.01358f,1.49480f,0.27390f,0.61219f,0.71452f,0.86807f,1.06713f,1.14540f },
	{ 433,0.31379f,0.01463f,1.54219f,0.27815f,0.62920f,0.73222f,0.88554f,1.08524f,1.15610f },
	{ 434,0.32165f,0.01572f,1.58488f,0.28243f,0.64620f,0.74991f,0.90302f,1.10334f,1.16680f },
	{ 435,0.32850f,0.01684f,1.62296f,0.28675f,0.66321f,0.76760f,0.92049f,1.12145f,1.17750f },
	{ 436,0.33435f,0.01801f,1.65640f,0.29111f,0.68022f,0.78529f,0.93797f,1.13956f,1.18500f },
	{ 437,0.33921f,0.01921f,1.68530f,0.29551f,0.69723f,0.80298f,0.95544f,1.15766f,1.19250f },
	{ 438,0.34312f,0.02045f,1.70987f,0.29994f,0.71423f,0.82067f,0.97292f,1.17577f,1.20000f },
	{ 439,0.34613f,0.02172f,1.73038f,0.30441f,0.73124f,0.83836f,0.99040f,1.19387f,1.20750f },
	{ 440,0.34828f,0.02300f,1.74706f,0.30892f,0.74825f,0.85605f,1.00787f,1.21198f,1.21500f },
	{ 441,0.34960f,0.02429f,1.76004f,0.31347f,0.76067f,0.86844f,1.01954f,1.22379f,1.21890f },
	{ 442,0.35015f,0.02561f,1.76962f,0.31806f,0.77309f,0.88083f,1.03122f,1.23560f,1.22280f },
	{ 443,0.35001f,0.02696f,1.77626f,0.32268f,0.78552f,0.89321f,1.04288f,1.24742f,1.22670f },
	{ 444,0.34929f,0.02835f,1.78043f,0.32734f,0.79794f,0.90560f,1.05455f,1.25923f,1.23060f },
	{ 445,0.34806f,0.02980f,1.78260f,0.33204f,0.81036f,0.91799f,1.06622f,1.27104f,1.23450f },
	{ 446,0.34637f,0.03131f,1.78297f,0.33678f,0.82278f,0.93038f,1.07790f,1.28285f,1.23560f },
	{ 447,0.34426f,0.03288f,1.78170f,0.34155f,0.83520f,0.94277f,1.08957f,1.29466f,1.23670f },
	{ 448,0.34181f,0.03452f,1.77920f,0.34637f,0.84763f,0.95515f,1.10123f,1.30648f,1.23780f },
	{ 449,0.33909f,0.03623f,1.77587f,0.35121f,0.86005f,0.96754f,1.11291f,1.31829f,1.23890f },
	{ 450,0.33620f,0.03800f,1.77211f,0.35610f,0.87247f,0.97993f,1.12458f,1.33010f,1.24000f },
	{ 451,0.33320f,0.03985f,1.76826f,0.36102f,0.87584f,0.98240f,1.12535f,1.32944f,1.23920f },
	{ 452,0.33004f,0.04177f,1.76404f,0.36598f,0.87920f,0.98487f,1.12613f,1.32879f,1.23840f },
	{ 453,0.32664f,0.04377f,1.75894f,0.37098f,0.88257f,0.98734f,1.12690f,1.32813f,1.23760f },
	{ 454,0.32289f,0.04584f,1.75247f,0.37601f,0.88593f,0.98981f,1.12767f,1.32748f,1.23680f },
	{ 455,0.31870f,0.04800f,1.74410f,0.38108f,0.88930f,0.99228f,1.12844f,1.32682f,1.23600f },
	{ 456,0.31403f,0.05024f,1.73356f,0.38618f,0.89266f,0.99475f,1.12921f,1.32617f,1.23500f },
	{ 457,0.30888f,0.05257f,1.72086f,0.39133f,0.89603f,0.99722f,1.12999f,1.32551f,1.23400f },
	{ 458,0.30329f,0.05498f,1.70594f,0.39650f,0.89939f,0.99969f,1.13076f,1.32486f,1.23300f },
	{ 459,0.29726f,0.05746f,1.68874f,0.40172f,0.90276f,1.00216f,1.13154f,1.32420f,1.23200f },
	{ 460,0.29080f,0.06000f,1.66920f,0.40697f,0.90612f,1.00463f,1.13231f,1.32355f,1.23100f },
	{ 461,0.28397f,0.06260f,1.64753f,0.41225f,0.90688f,1.00408f,1.12947f,1.31852f,1.23140f },
	{ 462,0.27672f,0.06528f,1.62341f,0.41757f,0.90763f,1.00353f,1.12664f,1.31348f,1.23180f },
	{ 463,0.26892f,0.06804f,1.59602f,0.42293f,0.90839f,1.00298f,1.12380f,1.30845f,1.23220f },
	{ 464,0.26042f,0.07091f,1.56453f,0.42832f,0.90914f,1.00243f,1.12097f,1.30341f,1.23260f },
	{ 465,0.25110f,0.07390f,1.52810f,0.43375f,0.90990f,1.00188f,1.11812f,1.29838f,1.23300f },
	{ 466,0.24085f,0.07702f,1.48611f,0.43921f,0.91066f,1.00133f,1.11529f,1.29335f,1.23400f },
	{ 467,0.22985f,0.08027f,1.43952f,0.44470f,0.91141f,1.00078f,1.11245f,1.28832f,1.23500f },
	{ 468,0.21841f,0.08367f,1.38988f,0.45023f,0.91217f,1.00023f,1.10961f,1.28328f,1.23600f },
	{ 469,0.20681f,0.08723f,1.33874f,0.45580f,0.91292f,0.99968f,1.10678f,1.27825f,1.23700f },
	{ 470,0.19536f,0.09098f,1.28764f,0.46140f,0.91368f,0.99913f,1.10394f,1.27322f,1.23800f },
	{ 471,0.18421f,0.09492f,1.23742f,0.46703f,0.91742f,1.00196f,1.10496f,1.27270f,1.23858f },
	{ 472,0.17333f,0.09905f,1.18782f,0.47270f,0.92116f,1.00478f,1.10598f,1.27218f,1.23916f },
	{ 473,0.16269f,0.10337f,1.13876f,0.47840f,0.92490f,1.00761f,1.10701f,1.27165f,1.23974f },
	{ 474,0.15228f,0.10788f,1.09015f,0.48413f,0.92864f,1.01043f,1.10803f,1.27113f,1.24032f },
	{ 475,0.14210f,0.11260f,1.04190f,0.48990f,0.93238f,1.01326f,1.10905f,1.27061f,1.24090f },
	{ 476,0.13218f,0.11753f,0.99420f,0.49570f,0.93612f,1.01609f,1.11007f,1.27009f,1.24052f },
	{ 477,0.12257f,0.12267f,0.94735f,0.50153f,0.93986f,1.01891f,1.11109f,1.26957f,1.24014f },
	{ 478,0.11328f,0.12799f,0.90145f,0.50740f,0.94361f,1.02174f,1.11211f,1.26904f,1.23976f },
	{ 479,0.10430f,0.13345f,0.85662f,0.51330f,0.94735f,1.02456f,1.11313f,1.26852f,1.23938f },
	{ 480,0.09564f,0.13902f,0.81295f,0.51923f,0.95109f,1.02739f,1.11415f,1.26800f,1.23900f },
	{ 481,0.08730f,0.14468f,0.77052f,0.52519f,0.94794f,1.02273f,1.10732f,1.25898f,1.23704f },
	{ 482,0.07931f,0.15047f,0.72944f,0.53118f,0.94480f,1.01807f,1.10048f,1.24996f,1.23508f },
	{ 483,0.07172f,0.15646f,0.68991f,0.53721f,0.94165f,1.01341f,1.09364f,1.24095f,1.23312f },
	{ 484,0.06458f,0.16272f,0.65210f,0.54327f,0.93851f,1.00875f,1.08681f,1.23193f,1.23116f },
	{ 485,0.05795f,0.16930f,0.61620f,0.54936f,0.93536f,1.00409f,1.07997f,1.22291f,1.22920f },
	{ 486,0.05186f,0.17624f,0.58233f,0.55548f,0.93221f,0.99943f,1.07314f,1.21389f,1.22476f },
	{ 487,0.04628f,0.18356f,0.55042f,0.56163f,0.92907f,0.99477f,1.06631f,1.20488f,1.22032f },
	{ 488,0.04115f,0.19127f,0.52034f,0.56781f,0.92592f,0.99010f,1.05946f,1.19586f,1.21588f },
	{ 489,0.03641f,0.19942f,0.49197f,0.57402f,0.92278f,0.98544f,1.05263f,1.18685f,1.21144f },
	{ 490,0.03201f,0.20802f,0.46518f,0.58026f,0.91963f,0.98078f,1.04580f,1.17783f,1.20700f },
	{ 491,0.02792f,0.21712f,0.43992f,0.58653f,0.92339f,0.98338f,1.04632f,1.17664f,1.19940f },
	{ 492,0.02414f,0.22673f,0.41618f,0.59283f,0.92715f,0.98598f,1.04684f,1.17544f,1.19180f },
	{ 493,0.02069f,0.23686f,0.39388f,0.59916f,0.93091f,0.98859f,1.04736f,1.17425f,1.18420f },
	{ 494,0.01754f,0.24748f,0.37295f,0.60552f,0.93467f,0.99119f,1.04788f,1.17305f,1.17660f },
	{ 495,0.01470f,0.25860f,0.35330f,0.61191f,0.93843f,0.99379f,1.04840f,1.17186f,1.16900f },
	{ 496,0.01216f,0.27018f,0.33486f,0.61833f,0.94219f,0.99639f,1.04893f,1.17067f,1.15940f },
	{ 497,0.00992f,0.28229f,0.31755f,0.62477f,0.94595f,0.99899f,1.04945f,1.16947f,1.14980f },
	{ 498,0.00797f,0.29505f,0.30134f,0.63125f,0.94972f,1.00160f,1.04997f,1.16828f,1.14020f },
	{ 499,0.00630f,0.30858f,0.28617f,0.63775f,0.95348f,1.00420f,1.05050f,1.16708f,1.13060f },
	{ 500,0.00490f,0.32300f,0.27200f,0.64428f,0.95724f,1.00680f,1.05102f,1.16589f,1.12100f },
	{ 501,0.00378f,0.33840f,0.25882f,0.65083f,0.95813f,1.00682f,1.04953f,1.16300f,1.11076f },
	{ 502,0.00295f,0.35469f,0.24648f,0.65742f,0.95902f,1.00683f,1.04804f,1.16012f,1.10052f },
	{ 503,0.00242f,0.37170f,0.23477f,0.66403f,0.95991f,1.00685f,1.04654f,1.15723f,1.09028f },
	{ 504,0.00224f,0.38929f,0.22345f,0.67066f,0.96080f,1.00686f,1.04505f,1.15435f,1.08004f },
	{ 505,0.00240f,0.40730f,0.21230f,0.67733f,0.96169f,1.00688f,1.04356f,1.15146f,1.06980f },
	{ 506,0.00293f,0.42563f,0.20117f,0.68402f,0.96258f,1.00689f,1.04207f,1.14857f,1.06044f },
	{ 507,0.00384f,0.44431f,0.19012f,0.69073f,0.96347f,1.00691f,1.04058f,1.14568f,1.05108f },
	{ 508,0.00517f,0.46339f,0.17923f,0.69748f,0.96435f,1.00692f,1.03908f,1.14280f,1.04172f },
	{ 509,0.00698f,0.48294f,0.16856f,0.70424f,0.96524f,1.00694f,1.03759f,1.13991f,1.03236f },
	{ 510,0.00930f,0.50300f,0.15820f,0.71103f,0.96613f,1.00695f,1.03610f,1.13702f,1.02300f },
	{ 511,0.01215f,0.52357f,0.14814f,0.71785f,0.96665f,1.00624f,1.03321f,1.13198f,1.01602f },
	{ 512,0.01554f,0.54451f,0.13838f,0.72469f,0.96716f,1.00553f,1.03031f,1.12694f,1.00904f },
	{ 513,0.01948f,0.56569f,0.12899f,0.73155f,0.96768f,1.00483f,1.02741f,1.12189f,1.00206f },
	{ 514,0.02399f,0.58697f,0.12008f,0.73844f,0.96819f,1.00412f,1.02452f,1.11685f,0.99508f },
	{ 515,0.02910f,0.60820f,0.11170f,0.74536f,0.96871f,1.00341f,1.02163f,1.11181f,0.98810f },
	{ 516,0.03481f,0.62935f,0.10390f,0.75229f,0.96923f,1.00270f,1.01873f,1.10677f,0.98428f },
	{ 517,0.04112f,0.65031f,0.09667f,0.75925f,0.96974f,1.00199f,1.01584f,1.10172f,0.98046f },
	{ 518,0.04799f,0.67088f,0.08998f,0.76623f,0.97026f,1.00129f,1.01294f,1.09668f,0.97664f },
	{ 519,0.05538f,0.69084f,0.08385f,0.77324f,0.97077f,1.00058f,1.01004f,1.09163f,0.97282f },
	{ 520,0.06327f,0.71000f,0.07825f,0.78026f,0.97129f,0.99987f,1.00715f,1.08659f,0.96900f },
	{ 521,0.07164f,0.72819f,0.07321f,0.78731f,0.97626f,1.00409f,1.00994f,1.08838f,0.96876f },
	{ 522,0.08046f,0.74546f,0.06868f,0.79438f,0.98123f,1.00831f,1.01273f,1.09016f,0.96852f },
	{ 523,0.08974f,0.76197f,0.06457f,0.80147f,0.98620f,1.01254f,1.01551f,1.09195f,0.96828f },
	{ 524,0.09946f,0.77784f,0.06079f,0.80859f,0.99117f,1.01676f,1.01830f,1.09373f,0.96804f },
	{ 525,0.10960f,0.79320f,0.05725f,0.81572f,0.99614f,1.02098f,1.02108f,1.09552f,0.96780f },
	{ 526,0.12017f,0.80811f,0.05390f,0.82288f,1.00111f,1.02520f,1.02386f,1.09731f,0.97024f },
	{ 527,0.13111f,0.82250f,0.05075f,0.83005f,1.00608f,1.02943f,1.02665f,1.09909f,0.97268f },
	{ 528,0.14237f,0.83631f,0.04775f,0.83725f,1.01105f,1.03365f,1.02944f,1.10088f,0.97512f },
	{ 529,0.15385f,0.84949f,0.04490f,0.84446f,1.01602f,1.03788f,1.03223f,1.10266f,0.97756f },
	{ 530,0.16550f,0.86200f,0.04216f,0.85169f,1.02099f,1.04210f,1.03501f,1.10445f,0.98000f },
	{ 531,0.17726f,0.87381f,0.03951f,0.85895f,1.01965f,1.03999f,1.03186f,1.10029f,0.98388f },
	{ 532,0.18914f,0.88496f,0.03694f,0.86622f,1.01830f,1.03788f,1.02870f,1.09614f,0.98776f },
	{ 533,0.20117f,0.89549f,0.03446f,0.87351f,1.01696f,1.03578f,1.02555f,1.09198f,0.99164f },
	{ 534,0.21337f,0.90544f,0.03209f,0.88082f,1.01561f,1.03367f,1.02238f,1.08783f,0.99552f },
	{ 535,0.22575f,0.91485f,0.02984f,0.88814f,1.01427f,1.03156f,1.01923f,1.08367f,0.99940f },
	{ 536,0.23832f,0.92373f,0.02771f,0.89549f,1.01293f,1.02945f,1.01608f,1.07951f,1.00372f },
	{ 537,0.25107f,0.93209f,0.02569f,0.90285f,1.01158f,1.02734f,1.01292f,1.07536f,1.00804f },
	{ 538,0.26399f,0.93992f,0.02379f,0.91023f,1.01024f,1.02524f,1.00976f,1.07120f,1.01236f },
	{ 539,0.27710f,0.94723f,0.02199f,0.91763f,1.00889f,1.02313f,1.00660f,1.06705f,1.01668f },
	{ 540,0.29040f,0.95400f,0.02030f,0.92504f,1.00755f,1.02102f,1.00345f,1.06289f,1.02100f },
	{ 541,0.30389f,0.96026f,0.01872f,0.93247f,1.00911f,1.02189f,1.00310f,1.06150f,1.02470f },
	{ 542,0.31757f,0.96601f,0.01724f,0.93991f,1.01067f,1.02275f,1.00276f,1.06012f,1.02840f },
	{ 543,0.33144f,0.97126f,0.01586f,0.94737f,1.01224f,1.02362f,1.00241f,1.05873f,1.03210f },
	{ 544,0.34548f,0.97602f,0.01458f,0.95484f,1.01380f,1.02448f,1.00207f,1.05735f,1.03580f },
	{ 545,0.35970f,0.98030f,0.01340f,0.96233f,1.01536f,1.02535f,1.00172f,1.05596f,1.03950f },
	{ 546,0.37408f,0.98409f,0.01231f,0.96984f,1.01692f,1.02622f,1.00138f,1.05458f,1.04200f },
	{ 547,0.38864f,0.98742f,0.01130f,0.97736f,1.01848f,1.02708f,1.00104f,1.05319f,1.04450f },
	{ 548,0.40338f,0.99031f,0.01038f,0.98489f,1.02005f,1.02795f,1.00069f,1.05181f,1.04700f },
	{ 549,0.41831f,0.99281f,0.00953f,0.99244f,1.02161f,1.02881f,1.00035f,1.05042f,1.04950f },
	{ 550,0.43345f,0.99495f,0.00875f,1.00000f,1.02317f,1.02968f,1.00000f,1.04904f,1.05200f },
	{ 551,0.44880f,0.99671f,0.00804f,1.00757f,1.02085f,1.02671f,0.99611f,1.04414f,1.05294f },
	{ 552,0.46434f,0.99810f,0.00738f,1.01516f,1.01854f,1.02374f,0.99222f,1.03923f,1.05388f },
	{ 553,0.48006f,0.99911f,0.00679f,1.02276f,1.01622f,1.02078f,0.98833f,1.03433f,1.05482f },
	{ 554,0.49597f,0.99975f,0.00624f,1.03037f,1.01391f,1.01781f,0.98445f,1.02942f,1.05576f },
	{ 555,0.51205f,1.00000f,0.00575f,1.03800f,1.01159f,1.01484f,0.98056f,1.02452f,1.05670f },
	{ 556,0.52830f,0.99986f,0.00530f,1.04563f,1.00927f,1.01187f,0.97666f,1.01962f,1.05596f },
	{ 557,0.54469f,0.99930f,0.00490f,1.05328f,1.00695f,1.00890f,0.97278f,1.01471f,1.05522f },
	{ 558,0.56121f,0.99833f,0.00453f,1.06094f,1.00464f,1.00594f,0.96889f,1.00981f,1.05448f },
	{ 559,0.57782f,0.99690f,0.00420f,1.06861f,1.00232f,1.00297f,0.96501f,1.00490f,1.05374f },
	{ 560,0.59450f,0.99500f,0.00390f,1.07629f,1.00000f,1.00000f,0.96111f,1.00000f,1.05300f },
	{ 561,0.61122f,0.99260f,0.00362f,1.08398f,0.99774f,0.99722f,0.95759f,0.99562f,1.05062f },
	{ 562,0.62798f,0.98974f,0.00337f,1.09168f,0.99547f,0.99443f,0.95407f,0.99123f,1.04824f },
	{ 563,0.64476f,0.98644f,0.00314f,1.09938f,0.99321f,0.99165f,0.95054f,0.98685f,1.04586f },
	{ 564,0.66157f,0.98272f,0.00293f,1.10711f,0.99094f,0.98886f,0.94702f,0.98246f,1.04348f },
	{ 565,0.67840f,0.97860f,0.00275f,1.11484f,0.98868f,0.98608f,0.94350f,0.97808f,1.04110f },
	{ 566,0.69524f,0.97408f,0.00259f,1.12258f,0.98641f,0.98330f,0.93997f,0.97370f,1.03748f },
	{ 567,0.71206f,0.96917f,0.00244f,1.13032f,0.98415f,0.98051f,0.93645f,0.96931f,1.03386f },
	{ 568,0.72883f,0.96386f,0.00231f,1.13808f,0.98188f,0.97773f,0.93293f,0.96493f,1.03024f },
	{ 569,0.74552f,0.95813f,0.00220f,1.14584f,0.97962f,0.97494f,0.92940f,0.96054f,1.02662f },
	{ 570,0.76210f,0.95200f,0.00210f,1.15361f,0.97735f,0.97216f,0.92588f,0.95616f,1.02300f },
	{ 571,0.77854f,0.94545f,0.00202f,1.16138f,0.97853f,0.97269f,0.92536f,0.95476f,1.01870f },
	{ 572,0.79483f,0.93850f,0.00195f,1.16917f,0.97972f,0.97322f,0.92483f,0.95335f,1.01440f },
	{ 573,0.81093f,0.93116f,0.00189f,1.17696f,0.98090f,0.97376f,0.92431f,0.95195f,1.01010f },
	{ 574,0.82682f,0.92346f,0.00184f,1.18476f,0.98209f,0.97429f,0.92378f,0.95054f,1.00580f },
	{ 575,0.84250f,0.91540f,0.00180f,1.19256f,0.98327f,0.97482f,0.92326f,0.94914f,1.00150f },
	{ 576,0.85793f,0.90701f,0.00177f,1.20037f,0.98445f,0.97535f,0.92273f,0.94774f,0.99680f },
	{ 577,0.87308f,0.89828f,0.00174f,1.20819f,0.98563f,0.97589f,0.92221f,0.94634f,0.99210f },
	{ 578,0.88789f,0.88920f,0.00171f,1.21601f,0.98682f,0.97642f,0.92168f,0.94493f,0.98740f },
	{ 579,0.90232f,0.87978f,0.00168f,1.22384f,0.98800f,0.97696f,0.92116f,0.94353f,0.98270f },
	{ 580,0.91630f,0.87000f,0.00165f,1.23166f,0.98918f,0.97749f,0.92063f,0.94213f,0.97800f },
	{ 581,0.92980f,0.85986f,0.00161f,1.23950f,0.98376f,0.97117f,0.91381f,0.93491f,0.97326f },
	{ 582,0.94280f,0.84939f,0.00156f,1.24734f,0.97834f,0.96485f,0.90698f,0.92770f,0.96852f },
	{ 583,0.95528f,0.83862f,0.00151f,1.25519f,0.97292f,0.95854f,0.90015f,0.92048f,0.96378f },
	{ 584,0.96722f,0.82758f,0.00146f,1.26303f,0.96750f,0.95222f,0.89333f,0.91327f,0.95904f },
	{ 585,0.97860f,0.81630f,0.00140f,1.27088f,0.96208f,0.94590f,0.88650f,0.90605f,0.95430f },
	{ 586,0.98939f,0.80479f,0.00134f,1.27874f,0.95666f,0.93958f,0.87967f,0.89883f,0.94984f },
	{ 587,0.99955f,0.79308f,0.00127f,1.28659f,0.95124f,0.93327f,0.87285f,0.89162f,0.94538f },
	{ 588,1.00909f,0.78119f,0.00120f,1.29445f,0.94583f,0.92695f,0.86602f,0.88440f,0.94092f },
	{ 589,1.01801f,0.76915f,0.00115f,1.30232f,0.94041f,0.92064f,0.85919f,0.87719f,0.93646f },
	{ 590,1.02630f,0.75700f,0.00110f,1.31018f,0.93499f,0.91432f,0.85237f,0.86997f,0.93200f },
	{ 591,1.03398f,0.74475f,0.00107f,1.31804f,0.93918f,0.91731f,0.85364f,0.87020f,0.92804f },
	{ 592,1.04099f,0.73242f,0.00105f,1.32591f,0.94337f,0.92030f,0.85491f,0.87043f,0.92408f },
	{ 593,1.04719f,0.72000f,0.00104f,1.33378f,0.94755f,0.92328f,0.85618f,0.87066f,0.92012f },
	{ 594,1.05247f,0.70750f,0.00102f,1.34165f,0.95174f,0.92627f,0.85745f,0.87089f,0.91616f },
	{ 595,1.05670f,0.69490f,0.00100f,1.34951f,0.95593f,0.92926f,0.85872f,0.87112f,0.91220f },
	{ 596,1.05979f,0.68222f,0.00097f,1.35739f,0.96012f,0.93225f,0.85999f,0.87135f,0.90916f },
	{ 597,1.06180f,0.66947f,0.00093f,1.36526f,0.96431f,0.93523f,0.86125f,0.87158f,0.90612f },
	{ 598,1.06281f,0.65667f,0.00089f,1.37313f,0.96850f,0.93822f,0.86252f,0.87181f,0.90308f },
	{ 599,1.06291f,0.64384f,0.00084f,1.38101f,0.97269f,0.94120f,0.86379f,0.87204f,0.90004f },
	{ 600,1.06220f,0.63100f,0.00080f,1.38887f,0.97688f,0.94419f,0.86506f,0.87227f,0.89700f },
	{ 601,1.06074f,0.61816f,0.00076f,1.39674f,0.97846f,0.94491f,0.86467f,0.87118f,0.89526f },
	{ 602,1.05844f,0.60531f,0.00072f,1.40461f,0.98004f,0.94563f,0.86428f,0.87010f,0.89352f },
	{ 603,1.05522f,0.59248f,0.00069f,1.41248f,0.98162f,0.94636f,0.86389f,0.86901f,0.89178f },
	{ 604,1.05098f,0.57964f,0.00065f,1.42033f,0.98320f,0.94708f,0.86350f,0.86793f,0.89004f },
	{ 605,1.04560f,0.56680f,0.00060f,1.42820f,0.98478f,0.94780f,0.86310f,0.86684f,0.88830f },
	{ 606,1.03904f,0.55396f,0.00055f,1.43606f,0.98636f,0.94852f,0.86271f,0.86575f,0.88744f },
	{ 607,1.03136f,0.54114f,0.00049f,1.44391f,0.98794f,0.94924f,0.86232f,0.86466f,0.88658f },
	{ 608,1.02267f,0.52835f,0.00044f,1.45177f,0.98953f,0.94996f,0.86193f,0.86358f,0.88572f },
	{ 609,1.01305f,0.51563f,0.00038f,1.45963f,0.99111f,0.95068f,0.86154f,0.86249f,0.88486f },
	{ 610,1.00260f,0.50300f,0.00034f,1.46747f,0.99269f,0.95140f,0.86115f,0.86140f,0.88400f },
	{ 611,0.99137f,0.49047f,0.00031f,1.47532f,0.99246f,0.95048f,0.85932f,0.85884f,0.88358f },
	{ 612,0.97933f,0.47803f,0.00028f,1.48317f,0.99223f,0.94956f,0.85750f,0.85628f,0.88316f },
	{ 613,0.96649f,0.46568f,0.00027f,1.49100f,0.99201f,0.94864f,0.85567f,0.85373f,0.88274f },
	{ 614,0.95285f,0.45340f,0.00025f,1.49884f,0.99178f,0.94772f,0.85384f,0.85117f,0.88232f },
	{ 615,0.93840f,0.44120f,0.00024f,1.50667f,0.99155f,0.94680f,0.85202f,0.84861f,0.88190f },
	{ 616,0.92319f,0.42908f,0.00023f,1.51450f,0.99132f,0.94588f,0.85019f,0.84605f,0.88172f },
	{ 617,0.90724f,0.41704f,0.00022f,1.52231f,0.99110f,0.94496f,0.84836f,0.84349f,0.88154f },
	{ 618,0.89050f,0.40503f,0.00021f,1.53013f,0.99087f,0.94404f,0.84654f,0.84093f,0.88136f },
	{ 619,0.87292f,0.39303f,0.00020f,1.53794f,0.99065f,0.94312f,0.84471f,0.83837f,0.88118f },
	{ 620,0.85445f,0.38100f,0.00019f,1.54574f,0.99042f,0.94220f,0.84288f,0.83581f,0.88100f },
	{ 621,0.83508f,0.36892f,0.00017f,1.55355f,0.98710f,0.93843f,0.83865f,0.83098f,0.88092f },
	{ 622,0.81495f,0.35683f,0.00016f,1.56134f,0.98378f,0.93466f,0.83441f,0.82614f,0.88084f },
	{ 623,0.79419f,0.34478f,0.00014f,1.56912f,0.98046f,0.93088f,0.83017f,0.82131f,0.88076f },
	{ 624,0.77295f,0.33282f,0.00012f,1.57690f,0.97714f,0.92711f,0.82593f,0.81647f,0.88068f },
	{ 625,0.75140f,0.32100f,0.00010f,1.58467f,0.97382f,0.92334f,0.82169f,0.81164f,0.88060f },
	{ 626,0.72958f,0.30934f,0.00009f,1.59244f,0.97050f,0.91957f,0.81745f,0.80681f,0.88048f },
	{ 627,0.70759f,0.29785f,0.00007f,1.60020f,0.96718f,0.91580f,0.81321f,0.80197f,0.88036f },
	{ 628,0.68560f,0.28659f,0.00007f,1.60795f,0.96386f,0.91202f,0.80897f,0.79714f,0.88024f },
	{ 629,0.66381f,0.27562f,0.00006f,1.61569f,0.96054f,0.90825f,0.80474f,0.79230f,0.88012f },
	{ 630,0.64240f,0.26500f,0.00005f,1.62343f,0.95722f,0.90448f,0.80050f,0.78747f,0.88000f },
	{ 631,0.62151f,0.25476f,0.00004f,1.63116f,0.96036f,0.90636f,0.80089f,0.78715f,0.87972f },
	{ 632,0.60111f,0.24489f,0.00004f,1.63887f,0.96349f,0.90824f,0.80129f,0.78683f,0.87944f },
	{ 633,0.58111f,0.23533f,0.00004f,1.64659f,0.96663f,0.91013f,0.80168f,0.78651f,0.87916f },
	{ 634,0.56140f,0.22605f,0.00003f,1.65430f,0.96976f,0.91201f,0.80208f,0.78619f,0.87888f },
	{ 635,0.54190f,0.21700f,0.00003f,1.66198f,0.97290f,0.91389f,0.80247f,0.78587f,0.87860f },
	{ 636,0.52260f,0.20816f,0.00003f,1.66967f,0.97603f,0.91577f,0.80287f,0.78555f,0.87848f },
	{ 637,0.50355f,0.19955f,0.00003f,1.67734f,0.97917f,0.91765f,0.80326f,0.78523f,0.87836f },
	{ 638,0.48474f,0.19116f,0.00002f,1.68501f,0.98230f,0.91954f,0.80366f,0.78492f,0.87824f },
	{ 639,0.46619f,0.18297f,0.00002f,1.69267f,0.98544f,0.92142f,0.80405f,0.78460f,0.87812f },
	{ 640,0.44790f,0.17500f,0.00002f,1.70031f,0.98857f,0.92330f,0.80444f,0.78428f,0.87800f },
	{ 641,0.42986f,0.16722f,0.00002f,1.70795f,0.98538f,0.91982f,0.80091f,0.78065f,0.87838f },
	{ 642,0.41210f,0.15965f,0.00002f,1.71557f,0.98219f,0.91635f,0.79738f,0.77702f,0.87876f },
	{ 643,0.39464f,0.15228f,0.00001f,1.72318f,0.97900f,0.91287f,0.79386f,0.77340f,0.87914f },
	{ 644,0.37753f,0.14513f,0.00001f,1.73079f,0.97581f,0.90940f,0.79033f,0.76977f,0.87952f },
	{ 645,0.36080f,0.13820f,0.00001f,1.73838f,0.97262f,0.90592f,0.78680f,0.76614f,0.87990f },
	{ 646,0.34446f,0.13150f,0.00001f,1.74596f,0.96943f,0.90244f,0.78327f,0.76251f,0.88032f },
	{ 647,0.32852f,0.12502f,0.00001f,1.75353f,0.96624f,0.89897f,0.77974f,0.75889f,0.88074f },
	{ 648,0.31302f,0.11878f,0.00000f,1.76109f,0.96305f,0.89549f,0.77621f,0.75526f,0.88116f },
	{ 649,0.29800f,0.11277f,0.00000f,1.76863f,0.95986f,0.89202f,0.77268f,0.75164f,0.88158f },
	{ 650,0.28350f,0.10700f,0.00000f,1.77618f,0.95667f,0.88854f,0.76915f,0.74801f,0.88200f },
	{ 651,0.26954f,0.10148f,0.00000f,1.78369f,0.95919f,0.89000f,0.76933f,0.74753f,0.88200f },
	{ 652,0.25612f,0.09619f,0.00000f,1.79120f,0.96172f,0.89147f,0.76951f,0.74705f,0.88200f },
	{ 653,0.24319f,0.09112f,0.00000f,1.79870f,0.96424f,0.89293f,0.76969f,0.74658f,0.88200f },
	{ 654,0.23073f,0.08626f,0.00000f,1.80618f,0.96677f,0.89440f,0.76987f,0.74610f,0.88200f },
	{ 655,0.21870f,0.08160f,0.00000f,1.81365f,0.96929f,0.89586f,0.77005f,0.74562f,0.88200f },
	{ 656,0.20710f,0.07712f,0.00000f,1.82111f,0.97181f,0.89732f,0.77023f,0.74514f,0.88140f },
	{ 657,0.19592f,0.07283f,0.00000f,1.82856f,0.97433f,0.89878f,0.77041f,0.74467f,0.88080f },
	{ 658,0.18517f,0.06871f,0.00000f,1.83600f,0.97686f,0.90025f,0.77059f,0.74419f,0.88020f },
	{ 659,0.17483f,0.06477f,0.00000f,1.84341f,0.97938f,0.90171f,0.77077f,0.74372f,0.87960f },
	{ 660,0.16490f,0.06100f,0.00000f,1.85082f,0.98190f,0.90317f,0.77095f,0.74324f,0.87900f },
	{ 661,0.15537f,0.05740f,0.00000f,1.85821f,0.98671f,0.90680f,0.77294f,0.74434f,0.87764f },
	{ 662,0.14623f,0.05396f,0.00000f,1.86558f,0.99153f,0.91043f,0.77492f,0.74544f,0.87628f },
	{ 663,0.13749f,0.05067f,0.00000f,1.87294f,0.99634f,0.91407f,0.77690f,0.74653f,0.87492f },
	{ 664,0.12915f,0.04755f,0.00000f,1.88030f,1.00116f,0.91770f,0.77889f,0.74763f,0.87356f },
	{ 665,0.12120f,0.04458f,0.00000f,1.88762f,1.00597f,0.92133f,0.78087f,0.74873f,0.87220f },
	{ 666,0.11364f,0.04176f,0.00000f,1.89494f,1.01078f,0.92496f,0.78285f,0.74983f,0.87036f },
	{ 667,0.10646f,0.03908f,0.00000f,1.90224f,1.01559f,0.92860f,0.78483f,0.75093f,0.86852f },
	{ 668,0.09969f,0.03656f,0.00000f,1.90954f,1.02041f,0.93223f,0.78682f,0.75202f,0.86668f },
	{ 669,0.09333f,0.03420f,0.00000f,1.91680f,1.02522f,0.93587f,0.78880f,0.75312f,0.86484f },
	{ 670,0.08740f,0.03200f,0.00000f,1.92407f,1.03003f,0.93950f,0.79078f,0.75422f,0.86300f },
	{ 671,0.08190f,0.02996f,0.00000f,1.93130f,1.02616f,0.93551f,0.78694f,0.75037f,0.86100f },
	{ 672,0.07680f,0.02808f,0.00000f,1.93853f,1.02229f,0.93151f,0.78311f,0.74653f,0.85900f },
	{ 673,0.07208f,0.02633f,0.00000f,1.94574f,1.01842f,0.92752f,0.77927f,0.74268f,0.85700f },
	{ 674,0.06769f,0.02471f,0.00000f,1.95293f,1.01455f,0.92352f,0.77543f,0.73884f,0.85500f },
	{ 675,0.06360f,0.02320f,0.00000f,1.96011f,1.01068f,0.91953f,0.77159f,0.73499f,0.85300f },
	{ 676,0.05981f,0.02180f,0.00000f,1.96727f,1.00681f,0.91554f,0.76775f,0.73114f,0.85040f },
	{ 677,0.05628f,0.02050f,0.00000f,1.97442f,1.00294f,0.91154f,0.76391f,0.72730f,0.84780f },
	{ 678,0.05297f,0.01928f,0.00000f,1.98154f,0.99907f,0.90755f,0.76008f,0.72345f,0.84520f },
	{ 679,0.04982f,0.01812f,0.00000f,1.98866f,0.99520f,0.90355f,0.75624f,0.71961f,0.84260f },
	{ 680,0.04677f,0.01700f,0.00000f,1.99575f,0.99133f,0.89956f,0.75240f,0.71576f,0.84000f },
	{ 681,0.04378f,0.01590f,0.00000f,2.00283f,0.97958f,0.88928f,0.74417f,0.70804f,0.83642f },
	{ 682,0.04088f,0.01484f,0.00000f,2.00989f,0.96783f,0.87900f,0.73594f,0.70031f,0.83284f },
	{ 683,0.03807f,0.01381f,0.00000f,2.01693f,0.95607f,0.86873f,0.72771f,0.69259f,0.82926f },
	{ 684,0.03540f,0.01283f,0.00000f,2.02396f,0.94432f,0.85845f,0.71948f,0.68486f,0.82568f },
	{ 685,0.03290f,0.01192f,0.00000f,2.03096f,0.93257f,0.84817f,0.71125f,0.67714f,0.82210f },
	{ 686,0.03056f,0.01107f,0.00000f,2.03795f,0.92082f,0.83789f,0.70302f,0.66942f,0.81808f },
	{ 687,0.02838f,0.01027f,0.00000f,2.04492f,0.90907f,0.82761f,0.69479f,0.66169f,0.81406f },
	{ 688,0.02634f,0.00953f,0.00000f,2.05188f,0.89731f,0.81733f,0.68656f,0.65397f,0.81004f },
	{ 689,0.02445f,0.00885f,0.00000f,2.05881f,0.88556f,0.80705f,0.67833f,0.64624f,0.80602f },
	{ 690,0.02270f,0.00821f,0.00000f,2.06573f,0.87381f,0.79677f,0.67010f,0.63852f,0.80200f },
	{ 691,0.02108f,0.00762f,0.00000f,2.07263f,0.87803f,0.79993f,0.67192f,0.63974f,0.79808f },
	{ 692,0.01960f,0.00709f,0.00000f,2.07951f,0.88225f,0.80309f,0.67373f,0.64097f,0.79416f },
	{ 693,0.01824f,0.00659f,0.00000f,2.08637f,0.88648f,0.80626f,0.67554f,0.64219f,0.79024f },
	{ 694,0.01699f,0.00614f,0.00000f,2.09321f,0.89070f,0.80942f,0.67736f,0.64342f,0.78632f },
	{ 695,0.01584f,0.00572f,0.00000f,2.10003f,0.89492f,0.81258f,0.67917f,0.64464f,0.78240f },
	{ 696,0.01479f,0.00534f,0.00000f,2.10683f,0.89914f,0.81574f,0.68099f,0.64586f,0.77852f },
	{ 697,0.01383f,0.00500f,0.00000f,2.11362f,0.90337f,0.81891f,0.68280f,0.64709f,0.77464f },
	{ 698,0.01295f,0.00468f,0.00000f,2.12038f,0.90759f,0.82207f,0.68462f,0.64831f,0.77076f },
	{ 699,0.01213f,0.00438f,0.00000f,2.12713f,0.91182f,0.82524f,0.68643f,0.64954f,0.76688f },
	{ 700,0.01136f,0.00410f,0.00000f,2.13386f,0.91604f,0.82840f,0.68824f,0.65076f,0.76300f },
	{ 701,0.01063f,0.00384f,0.00000f,2.14056f,0.91732f,0.83040f,0.69088f,0.65375f,0.75912f },
	{ 702,0.00994f,0.00359f,0.00000f,2.14726f,0.91861f,0.83241f,0.69351f,0.65675f,0.75524f },
	{ 703,0.00929f,0.00335f,0.00000f,2.15392f,0.91989f,0.83441f,0.69614f,0.65974f,0.75136f },
	{ 704,0.00868f,0.00313f,0.00000f,2.16057f,0.92118f,0.83642f,0.69878f,0.66274f,0.74748f },
	{ 705,0.00811f,0.00293f,0.00000f,2.16720f,0.92246f,0.83842f,0.70141f,0.66573f,0.74360f },
	{ 706,0.00758f,0.00274f,0.00000f,2.17380f,0.92375f,0.84042f,0.70404f,0.66872f,0.73968f },
	{ 707,0.00709f,0.00256f,0.00000f,2.18039f,0.92503f,0.84243f,0.70668f,0.67172f,0.73576f },
	{ 708,0.00663f,0.00239f,0.00000f,2.18696f,0.92632f,0.84443f,0.70931f,0.67471f,0.73184f },
	{ 709,0.00620f,0.00224f,0.00000f,2.19351f,0.92760f,0.84644f,0.71194f,0.67771f,0.72792f },
	{ 710,0.00579f,0.00209f,0.00000f,2.20003f,0.92889f,0.84844f,0.71458f,0.68070f,0.72400f },
	{ 711,0.00541f,0.00195f,0.00000f,2.20653f,0.91286f,0.83383f,0.70233f,0.66907f,0.72000f },
	{ 712,0.00505f,0.00182f,0.00000f,2.21302f,0.89682f,0.81922f,0.69008f,0.65744f,0.71600f },
	{ 713,0.00472f,0.00170f,0.00000f,2.21948f,0.88079f,0.80461f,0.67783f,0.64582f,0.71200f },
	{ 714,0.00440f,0.00159f,0.00000f,2.22592f,0.86475f,0.79000f,0.66558f,0.63419f,0.70800f },
	{ 715,0.00411f,0.00148f,0.00000f,2.23234f,0.84872f,0.77539f,0.65333f,0.62256f,0.70400f },
	{ 716,0.00383f,0.00138f,0.00000f,2.23874f,0.83268f,0.76078f,0.64108f,0.61093f,0.69980f },
	{ 717,0.00358f,0.00129f,0.00000f,2.24512f,0.81665f,0.74617f,0.62883f,0.59931f,0.69560f },
	{ 718,0.00333f,0.00120f,0.00000f,2.25147f,0.80061f,0.73157f,0.61658f,0.58768f,0.69140f },
	{ 719,0.00311f,0.00112f,0.00000f,2.25781f,0.78458f,0.71696f,0.60433f,0.57606f,0.68720f },
	{ 720,0.00290f,0.00105f,0.00000f,2.26413f,0.76854f,0.70235f,0.59208f,0.56443f,0.68300f },
	{ 721,0.00270f,0.00098f,0.00000f,2.27042f,0.77820f,0.71142f,0.60004f,0.57223f,0.67900f },
	{ 722,0.00252f,0.00091f,0.00000f,2.27669f,0.78786f,0.72048f,0.60800f,0.58003f,0.67500f },
	{ 723,0.00235f,0.00085f,0.00000f,2.28293f,0.79751f,0.72955f,0.61596f,0.58783f,0.67100f },
	{ 724,0.00220f,0.00079f,0.00000f,2.28917f,0.80717f,0.73861f,0.62392f,0.59563f,0.66700f },
	{ 725,0.00205f,0.00074f,0.00000f,2.29538f,0.81683f,0.74768f,0.63188f,0.60343f,0.66300f },
	{ 726,0.00191f,0.00069f,0.00000f,2.30155f,0.82649f,0.75675f,0.63984f,0.61123f,0.65920f },
	{ 727,0.00178f,0.00064f,0.00000f,2.30772f,0.83614f,0.76581f,0.64780f,0.61903f,0.65540f },
	{ 728,0.00166f,0.00060f,0.00000f,2.31386f,0.84580f,0.77488f,0.65576f,0.62682f,0.65160f },
	{ 729,0.00155f,0.00056f,0.00000f,2.31997f,0.85545f,0.78394f,0.66372f,0.63462f,0.64780f },
	{ 730,0.00144f,0.00052f,0.00000f,2.32607f,0.86511f,0.79301f,0.67168f,0.64242f,0.64400f },
	{ 731,0.00134f,0.00048f,0.00000f,2.33214f,0.87118f,0.79870f,0.67668f,0.64733f,0.64080f },
	{ 732,0.00125f,0.00045f,0.00000f,2.33819f,0.87725f,0.80439f,0.68168f,0.65224f,0.63760f },
	{ 733,0.00116f,0.00042f,0.00000f,2.34422f,0.88332f,0.81009f,0.68668f,0.65715f,0.63440f },
	{ 734,0.00108f,0.00039f,0.00000f,2.35022f,0.88939f,0.81578f,0.69168f,0.66206f,0.63120f },
	{ 735,0.00100f,0.00036f,0.00000f,2.35621f,0.89546f,0.82147f,0.69668f,0.66697f,0.62800f },
	{ 736,0.00093f,0.00034f,0.00000f,2.36216f,0.90153f,0.82716f,0.70167f,0.67188f,0.62540f },
	{ 737,0.00086f,0.00031f,0.00000f,2.36810f,0.90760f,0.83285f,0.70667f,0.67679f,0.62280f },
	{ 738,0.00080f,0.00029f,0.00000f,2.37401f,0.91366f,0.83855f,0.71167f,0.68169f,0.62020f },
	{ 739,0.00074f,0.00027f,0.00000f,2.37991f,0.91973f,0.84424f,0.71667f,0.68660f,0.61760f },
	{ 740,0.00069f,0.00025f,0.00000f,2.38577f,0.92580f,0.84993f,0.72167f,0.69151f,0.61500f },
	{ 741,0.00064f,0.00023f,0.00000f,2.39162f,0.91145f,0.83682f,0.71062f,0.68099f,0.61240f },
	{ 742,0.00059f,0.00021f,0.00000f,2.39744f,0.89710f,0.82371f,0.69958f,0.67047f,0.60980f },
	{ 743,0.00055f,0.00020f,0.00000f,2.40324f,0.88275f,0.81059f,0.68853f,0.65994f,0.60720f },
	{ 744,0.00051f,0.00019f,0.00000f,2.40901f,0.86840f,0.79748f,0.67748f,0.64942f,0.60460f },
	{ 745,0.00048f,0.00017f,0.00000f,2.41477f,0.85405f,0.78437f,0.66643f,0.63890f,0.60200f },
	{ 746,0.00044f,0.00016f,0.00000f,2.42049f,0.83970f,0.77126f,0.65539f,0.62838f,0.60000f },
	{ 747,0.00041f,0.00015f,0.00000f,2.42620f,0.82535f,0.75814f,0.64434f,0.61786f,0.59800f },
	{ 748,0.00038f,0.00014f,0.00000f,2.43188f,0.81100f,0.74503f,0.63329f,0.60733f,0.59600f },
	{ 749,0.00036f,0.00013f,0.00000f,2.43754f,0.79665f,0.73191f,0.62224f,0.59681f,0.59400f },
	{ 750,0.00033f,0.00012f,0.00000f,2.44317f,0.78230f,0.71880f,0.61120f,0.58629f,0.59200f },
	{ 751,0.00031f,0.00011f,0.00000f,2.44879f,0.76176f,0.69971f,0.59469f,0.57028f,0.59060f },
	{ 752,0.00029f,0.00010f,0.00000f,2.45438f,0.74122f,0.68063f,0.57818f,0.55427f,0.58920f },
	{ 753,0.00027f,0.00010f,0.00000f,2.45994f,0.72069f,0.66154f,0.56168f,0.53825f,0.58780f },
	{ 754,0.00025f,0.00009f,0.00000f,2.46548f,0.70015f,0.64246f,0.54517f,0.52224f,0.58640f },
	{ 755,0.00023f,0.00008f,0.00000f,2.47099f,0.67961f,0.62337f,0.52866f,0.50623f,0.58500f },
	{ 756,0.00022f,0.00008f,0.00000f,2.47649f,0.65907f,0.60428f,0.51216f,0.49022f,0.58420f },
	{ 757,0.00020f,0.00007f,0.00000f,2.48196f,0.63853f,0.58519f,0.49565f,0.47421f,0.58340f },
	{ 758,0.00019f,0.00007f,0.00000f,2.48741f,0.61800f,0.56611f,0.47914f,0.45819f,0.58260f },
	{ 759,0.00018f,0.00006f,0.00000f,2.49283f,0.59746f,0.54702f,0.46264f,0.44218f,0.58180f },
	{ 760,0.00017f,0.00006f,0.00000f,2.49822f,0.57692f,0.52793f,0.44613f,0.42617f,0.58100f },
	{ 761,0.00016f,0.00006f,0.00000f,2.50361f,0.60215f,0.55106f,0.46573f,0.44491f,0.58080f },
	{ 762,0.00014f,0.00005f,0.00000f,2.50895f,0.62738f,0.57420f,0.48532f,0.46364f,0.58060f },
	{ 763,0.00013f,0.00005f,0.00000f,2.51427f,0.65261f,0.59733f,0.50492f,0.48238f,0.58040f },
	{ 764,0.00013f,0.00005f,0.00000f,2.51958f,0.67784f,0.62047f,0.52451f,0.50111f,0.58020f },
	{ 765,0.00012f,0.00004f,0.00000f,2.52485f,0.70307f,0.64360f,0.54410f,0.51985f,0.58000f },
	{ 766,0.00011f,0.00004f,0.00000f,2.53011f,0.72830f,0.66673f,0.56370f,0.53858f,0.58040f },
	{ 767,0.00010f,0.00004f,0.00000f,2.53535f,0.75353f,0.68987f,0.58329f,0.55732f,0.58080f },
	{ 768,0.00010f,0.00003f,0.00000f,2.54054f,0.77877f,0.71300f,0.60289f,0.57605f,0.58120f },
	{ 769,0.00009f,0.00003f,0.00000f,2.54573f,0.80400f,0.73614f,0.62248f,0.59479f,0.58160f },
	{ 770,0.00008f,0.00003f,0.00000f,2.55089f,0.82923f,0.75927f,0.64208f,0.61352f,0.58200f },
	{ 771,0.00008f,0.00003f,0.00000f,2.55602f,0.82458f,0.75516f,0.63879f,0.61049f,0.58260f },
	{ 772,0.00007f,0.00003f,0.00000f,2.56112f,0.81993f,0.75105f,0.63550f,0.60746f,0.58320f },
	{ 773,0.00007f,0.00002f,0.00000f,2.56621f,0.81529f,0.74694f,0.63221f,0.60444f,0.58380f },
	{ 774,0.00006f,0.00002f,0.00000f,2.57127f,0.81064f,0.74283f,0.62892f,0.60141f,0.58440f },
	{ 775,0.00006f,0.00002f,0.00000f,2.57631f,0.80599f,0.73872f,0.62563f,0.59838f,0.58500f },
	{ 776,0.00005f,0.00002f,0.00000f,2.58132f,0.80134f,0.73461f,0.62234f,0.59535f,0.58620f },
	{ 777,0.00005f,0.00002f,0.00000f,2.58631f,0.79669f,0.73050f,0.61905f,0.59232f,0.58740f },
	{ 778,0.00005f,0.00002f,0.00000f,2.59127f,0.79204f,0.72640f,0.61576f,0.58930f,0.58860f },
	{ 779,0.00004f,0.00002f,0.00000f,2.59621f,0.78739f,0.72229f,0.61247f,0.58627f,0.58980f },
	{ 780,0.00000f,0.00000f,0.00000f,2.60112f,0.78274f,0.71818f,0.60918f,0.58324f,0.59100f }

};





/************************ exported functions ************************************************************/

/* Simple query functions */

int corGetCMFCIExyz(float lambda, float* x_bar, float* y_bar, float* z_bar)
{
	if (lambda<380.01 || lambda>779.99) {
		if (x_bar) *x_bar = 0;
		if (y_bar) *y_bar = 0;
		if (z_bar) *z_bar = 0;
		return 0;
	}
	else {
		int   lambda_i = (int)lambda;
		float delta = lambda - lambda_i;
		int   i = lambda_i - 380;
		if (x_bar) *x_bar = spec[i].x_bar + delta*(spec[i + 1].x_bar - spec[i].x_bar);
		if (y_bar) *y_bar = spec[i].y_bar + delta*(spec[i + 1].y_bar - spec[i].y_bar);
		if (z_bar) *z_bar = spec[i].z_bar + delta*(spec[i + 1].z_bar - spec[i].z_bar);
		return 1;
	}
}


float corGetRadianceD65(float lambda)
{
	if (lambda<380.01)
		return spec[0].D65;
	else if (lambda>779.99)
		return spec[400].D65;
	else {
		int   lambda_i = (int)lambda;
		float delta = lambda - lambda_i;
		int i = lambda_i - 380;
		return spec[i].D65 + delta*(spec[i + 1].D65 - spec[i].D65);
	}
}

float corGetRadianceA(float lambda)
{
	if (lambda<380.01)
		return spec[0].A;
	else if (lambda>779.99)
		return spec[400].A;
	else {
		int   lambda_i = (int)lambda;
		float delta = lambda - lambda_i;
		int i = lambda_i - 380;
		return spec[i].A + delta*(spec[i + 1].A - spec[i].A);
	}
}

float corGetRadianceD50(float lambda)
{
	if (lambda<380.01)
		return spec[0].D50;
	else if (lambda>779.99)
		return spec[400].D50;
	else {
		int   lambda_i = (int)lambda;
		float delta = lambda - lambda_i;
		int i = lambda_i - 380;
		return spec[i].D50 + delta*(spec[i + 1].D50 - spec[i].D50);
	}
}


float corGetRadianceD55(float lambda)
{
	if (lambda<380.01)
		return spec[0].D55;
	else if (lambda>779.99)
		return spec[400].D55;
	else {
		int   lambda_i = (int)lambda;
		float delta = lambda - lambda_i;
		int i = lambda_i - 380;
		return spec[i].D55 + delta*(spec[i + 1].D55 - spec[i].D55);
	}
}


float corGetRadianceD75(float lambda)
{
	if (lambda<380.01)
		return spec[0].D75;
	else if (lambda>779.99)
		return spec[400].D75;
	else {
		int   lambda_i = (int)lambda;
		float delta = lambda - lambda_i;
		int i = lambda_i - 380;
		return spec[i].D75 + delta*(spec[i + 1].D75 - spec[i].D75);
	}
}

float corGetRadianceC(float lambda)
{
	if (lambda<380.01)
		return spec[0].C;
	else if (lambda>779.99)
		return spec[400].C;
	else {
		int   lambda_i = (int)lambda;
		float delta = lambda - lambda_i;
		int i = lambda_i - 380;
		return spec[i].C + delta*(spec[i + 1].C - spec[i].C);
	}
}



float corGetIllum(float lambda, int reference_light) {
	if (reference_light == A)         return corGetRadianceA(lambda);
	else if (reference_light == D50)  return corGetRadianceD50(lambda);
	else if (reference_light == D55)  return corGetRadianceD55(lambda);
	else if (reference_light == D65)  return corGetRadianceD65(lambda);
	else if (reference_light == D75)  return corGetRadianceD75(lambda);
	else if (reference_light == C)    return corGetRadianceC(lambda);
	else if (reference_light == I100) return 1.f;
	else return corGetRadianceD65(lambda);
}

/* Color Systems: Color Conversion Functions************************************************************* */
int corCIEXYZtoCIERGB(float X, float Y, float Z, float* R, float* G, float* B) {
	//double m[3*3] = { 2.36440, -0.89580, -0.46770, -0.51483, 1.42523, 0.08817, 0.00520, -0.01440, 1.00921 };
	double m[3 * 3] = { 0.41843,-0.15853,-0.08277,-0.09111,0.25222,0.01560,0.00092,-0.00255,0.17860 };
	*R = (float)(m[0] * X + m[1] * Y + m[2] * Z);
	*G = (float)(m[3] * X + m[4] * Y + m[5] * Z);
	*B = (float)(m[6] * X + m[7] * Y + m[8] * Z);
	return 1;
}

int corCIERGBtoCIEXYZ(float r_bar, float g_bar, float b_bar, float* x_bar, float* y_bar, float* z_bar) {
	//double m[3*3] = { 0.490, 0.310, 0.200,  0.177, 0.813, 0.011, 0.000, 0.010, 0.990 }; 
	double m[3 * 3] = { 2.76883,1.75171,1.13014,1.00017,4.59400,0.06216,0.00000,0.05651,5.59417 };
	*x_bar = (float)(m[0] * r_bar + m[1] * g_bar + m[2] * b_bar);
	*y_bar = (float)(m[3] * r_bar + m[4] * g_bar + m[5] * b_bar);
	*z_bar = (float)(m[6] * r_bar + m[7] * g_bar + m[8] * b_bar);
	return 1;
}

int corCIEXYZtoCIExyY(float X, float Y, float Z, float* x, float* y) {
	double sum = (double)X + Y + Z;
	if (sum<1.e-6) return 0;
	*x = (float)(X / sum);
	*y = (float)(Y / sum);
	return 1;
}


int corCIExyYtoXYZ(float x, float y, float Y, float* X, float* Z) {
	double scale = (double)Y / y;
	double z = 1.0 - x - y;
	if (y<1.e-6f) return 0;
	*X = (float)(x*scale);
	*Z = (float)(z*scale);
	return 1;
}

static double gamma_sRGB(double x) {
	double ft, t = (x>0) ? x : -x;
	if (t>0.0031308)
		ft = 1.055*pow(t, 1.0 / 2.4) - 0.055;
	else
		ft = 12.92*t;

	return (x>0) ? ft : -ft;
}


/* r,g,b from 0 to 1 */
int corCIEXYZtosRGB(float X, float Y, float Z, float* pR, float* pG, float* pB, int reference_light) {
	double r, g, b;
	int error = 0;
	if (reference_light == D50) {
		r = 3.3921940*X - 1.6168667*Y - 0.4906146*Z;
		g = -0.9787684*X + 1.9161415*Y + 0.0334540*Z;
		b = 0.0719453*X - 0.2289914*Y + 1.4052427*Z;
	}
	else {  /* default D65 */
		r = 3.2404542*X - 1.5371385*Y - 0.4985314*Z;
		g = -0.9692660*X + 1.8760108*Y + 0.0415560*Z;
		b = 0.0556434*X - 0.2040259*Y + 1.0572252*Z;
	}
	r = gamma_sRGB(r);
	g = gamma_sRGB(g);
	b = gamma_sRGB(b);

	*pR = (float)r;
	*pG = (float)g;
	*pB = (float)b;

	if (r<0 || g<0 || b<0 || r>1 || g>1 || b>1)  error = 1;

	return error;
}

static double inv_gamma_sRGB(float x) {
	double ft, t = (double)(x>0) ? x : -x;
	if (t > 0.04045)
		ft = pow((t + 0.055) / 1.055, 2.4);
	else
		ft = t / 12.92;

	return (x>0) ? ft : -ft;
}


int corsRGBtoCIEXYZ(float R, float G, float B, float* X, float* Y, float* Z, int reference_light) {
	double Rc = inv_gamma_sRGB(R);
	double Gc = inv_gamma_sRGB(G);
	double Bc = inv_gamma_sRGB(B);

	*X = (float)(Rc*0.4124564 + Gc*0.3575761 + Bc*0.1804375);
	*Y = (float)(Rc*0.2126729 + Gc*0.7151522 + Bc*0.0721750);
	*Z = (float)(Rc*0.0193339 + Gc*0.1191920 + Bc*0.9503041);

	return (*X<0 || *Y<0 || *Z<0) ? 0 : 1;
}

static double gamma_Lab(double t) {
	double ft, e = 216.0 / 24389, k = 24389.0 / 27;
	if (t>e)
		ft = pow(t, 1.0 / 3);
	else
		ft = (k*t + 16) / 116;
	return ft;
}



int corCIEXYZtoLab(float X, float Y, float Z, float* L, float* a, float* b, int reference_light) {
	double xr = (double)X / reference_white[reference_light][0];
	double yr = (double)Y / reference_white[reference_light][1];
	double zr = (double)Z / reference_white[reference_light][2];

	double fx = gamma_Lab(xr);
	double fy = gamma_Lab(yr);
	double fz = gamma_Lab(zr);

	*L = (float)(116 * fy - 16);
	*a = (float)(500 * (fx - fy));
	*b = (float)(200 * (fy - fz));

	return (*L<0 || *L>100) ? 0 : 1;
}

int corCIELabtoXYZ(float L, float a, float b, float* X, float* Y, float* Z, int reference_light) {
	double fx, fy, fz, fx3, fy3, fz3, xr, yr, zr;
	double e = 216.0 / 24389;
	double k = 24389.0 / 27;

	fy = (L + 16.0) / 116;
	fx = a / 500.0 + fy;
	fz = fy - b / 200;

	fx3 = fx*fx*fx;
	fy3 = fy*fy*fy;
	fz3 = fz*fz*fz;

	xr = (fx3>e) ? fx3 : (116 * fx - 16) / k;
	yr = ((double)L>k*e) ? fy3 : L / k;
	zr = (fz3>e) ? fz3 : (116 * fz - 16) / k;

	*X = (float)(reference_white[reference_light][0] * xr);
	*Y = (float)(reference_white[reference_light][1] * yr);
	*Z = (float)(reference_white[reference_light][2] * zr);

	return (*X<0 || *Y<0 || *Z<0) ? 0 : 1;
}

int corCIELabtosRGB(float L, float a, float b, float* R, float* G, float* B, int reference_light) {
	float X, Y, Z;
	int ok = corCIELabtoXYZ(L, a, b, &X, &Y, &Z, reference_light);
	if (ok)
		ok = corCIEXYZtosRGB(X, Y, Z, R, G, B, reference_light);
	else {
		*R = *G = *B = 0;
	}
	return ok;
}
static float min3(float v1, float v2, float v3)
{
	if (v1 < v2)
		return (v1 < v3) ? v1 : v3;
	else
		return (v2 < v3) ? v2 : v3;
}

static float max3(float v1, float v2, float v3)
{
	if (v1 > v2)
		return (v1 > v3) ? v1 : v3;
	else
		return (v2 > v3) ? v2 : v3;
}

static float HueToRGB(float v1, float v2, float H)
{
	if (H < 0) H += 1;
	if (H > 1) H -= 1;
	if ((6 * H) < 1) return (v1 + (v2 - v1) * 6 * H);
	if ((2 * H) < 1) return (v2);
	if ((3 * H) < 2) return (v1 + (v2 - v1) * ((2.0f / 3) - H) * 6);
	return (v1);
}

/* RGB values = From 0 to 1 */
void corRGBtoHSL(float r, float g, float b, float* H, float* S, float* L)
{
	float minValue, maxValue, delta;
	float dr, dg, db;

	minValue = min3(r, g, b);                /* Min. value of RGB */
	maxValue = max3(r, g, b);                /* Max. value of RGB */
	delta = maxValue - minValue;              /* Delta RGB value */

	*L = (maxValue + minValue) / 2;

	if (delta == 0)                     /* This is a gray, no chroma... */
	{
		*H = 0;                            /* HSL results = From 0 to 1 */
		*S = 0;
	}
	else                                  /* Chromatic data... */
	{
		if (*L < 0.5) *S = delta / (maxValue + minValue);
		else            *S = delta / (2 - maxValue - minValue);

		dr = (((maxValue - r) / 6) + (delta / 2)) / delta;
		dg = (((maxValue - g) / 6) + (delta / 2)) / delta;
		db = (((maxValue - b) / 6) + (delta / 2)) / delta;

		if (r == maxValue) *H = db - dg;
		else if (g == maxValue) *H = (1.0f / 3) + dr - db;
		else if (b == maxValue) *H = (2.0f / 3) + dg - dr;

		if (*H < 0) *H += 1;
		if (*H > 1) *H -= 1;
	}

}

void corHSLtoRGB(float H, float S, float L, float* r, float* g, float* b)
{
	float v1, v2;

	if (S == 0)                       /* HSL values = From 0 to 1 */
	{
		*r = L;                     /* RGB results = From 0 to 1  */
		*g = L;
		*b = L;
	}
	else
	{
		if (L < 0.5)
			v2 = L * (1 + S);
		else
			v2 = (L + S) - (S * L);

		v1 = 2 * L - v2;

		*r = HueToRGB(v1, v2, H + (1.0f / 3));
		*g = HueToRGB(v1, v2, H);
		*b = HueToRGB(v1, v2, H - (1.0f / 3));
	}

}


/* if s == 0, then h = undefined but the function will return h=0 */
void corRGBtoHSV(float r, float g, float b, float *h, float *s, float *v)
{
	float min, max, delta;

	min = min3(r, g, b);
	max = max3(r, g, b);
	*v = max;

	delta = max - min;

	if (max > FLT_EPSILON)
		*s = delta / max;
	else {                  /* r = g = b = 0  => v=s=0, h is undefined, but assumed zero */
		*s = *v = 0;
		*h = 0;

		return;
	}

	if (delta < FLT_EPSILON)
		*h = 0;
	else if (r == max)
		*h = (g - b) / delta;		/*between yellow & magenta*/
	else if (g == max)
		*h = 2 + (b - r) / delta;	 /*between cyan & yellow*/
	else
		*h = 4 + (r - g) / delta;	 /*between magenta & cyan*/

	*h /= 6;
	if (*h < 0)
		*h += 1;

}

void corHSVtoRGB(float h, float s, float v, float *r, float *g, float *b)
{
	if (s == 0) {  /* grey */
		*r = *g = *b = v;
	}
	else {
		int i;
		float f, p, q, t;
		h *= 6;			/*six sectors, sector 0 to 5 */
		i = (int)h;    /* integer part */
		f = h - i;		/* fractional part */
		p = v * (1 - s);
		q = v * (1 - s * f);
		t = v * (1 - s * (1 - f));
		switch (i) {     /* sector */
		case 0:
			*r = v;
			*g = t;
			*b = p;
			break;
		case 1:
			*r = q;
			*g = v;
			*b = p;
			break;
		case 2:
			*r = p;
			*g = v;
			*b = t;
			break;
		case 3:
			*r = p;
			*g = q;
			*b = v;
			break;
		case 4:
			*r = t;
			*g = p;
			*b = v;
			break;
		default:		/* case 5:  */
			*r = v;
			*g = p;
			*b = q;
			break;
		}
	}
}

/* color difference function */
float corDelta_2000_Lab(float L1, float a1, float b1, float L2, float a2, float b2)
{
	float C1, C2;
	float h1, h2;
	float dL, dC, dH;
	float dsq;

	/* Compute Cromanance and Hue angles */
	{
		float C1ab, C2ab;
		float Cab, Cab7, G;
		float var_a1, var_a2;

		C1ab = (float)sqrt(a1*a1 + b1*b1);
		C2ab = (float)sqrt(a2*a2 + b2*b2);
		Cab = (C1ab + C2ab) / 2;
		Cab7 = (float)pow(Cab, 7.0);
		G = (float)(0.5 * (1.0 - sqrt(Cab7 / (Cab7 + 6103515625.0))));
		var_a1 = (1 + G) * a1;
		var_a2 = (1 + G) * a2;
		C1 = (float)sqrt(var_a1 * var_a1 + b1*b1);
		C2 = (float)sqrt(var_a2 * var_a2 + b2*b2);

		if (C1 < 1e-9f)
			h1 = 0;
		else {
			h1 = (float)RAD2DEG(atan2(b1, var_a1));
			if (h1 < 0)
				h1 += 360;
		}

		if (C2 < 1e-9f)
			h2 = 0;
		else {
			h2 = (float)RAD2DEG(atan2(b2, var_a2));
			if (h2 < 0)
				h2 += 360;
		}
	}

	/* Compute delta L, C and H */
	{
		float dh;

		dL = L2 - L2;
		dC = C2 - C1;
		if (C1 < 1e-6f || C2 < 1e-6f) {
			dh = 0;
		}
		else {
			dh = h2 - h1;
			if (dh > 180)
				dh -= 360;
			else if (dh < -180)
				dh += 360;
		}

		dH = (float)(2 * sqrt(C1 * C2) * sin(DEG2RAD(0.5 * dh)));
	}

	{
		float L, C, h, T;
		float hh, ddeg;
		float C7, RC, L50sq, SL, SC, SH, RT;
		float dLsq, dCsq, dHsq, RCH;

		L = (L1 + L2) / 2;
		C = (C1 + C2) / 2;
		if (C1 < 1e-6f || C2 < 1e-6f) {
			h = h1 + h2;
		}
		else {
			h = h1 + h2;
			if (fabs(h1 - h2) > 180) {
				if (h < 360)
					h += 360;
				else if (h >= 360)
					h -= 360;
			}
			h *= 0.5f;
		}
		T = (float)(1.0 - 0.17*cos(DEG2RAD(h - 30)) + 0.24*cos(DEG2RAD(2 * h))
			+ 0.32*cos(DEG2RAD(3 * h + 6)) - 0.2*cos(DEG2RAD(4 * h - 63)));
		hh = (h - 275) / 25;
		ddeg = (float)(30 * exp(-hh * hh));
		C7 = (float)pow(C, 7.0);
		RC = (float)(2 * sqrt(C7 / (C7 + 6103515625.0)));
		L50sq = (L - 50) * (L - 50);
		SL = (float)(1 + (0.015 * L50sq) / sqrt(20.0 + L50sq));
		SC = (float)(1 + 0.045*C);
		SH = (float)(1 + 0.015*C*T);
		RT = (float)(-sin(DEG2RAD(2 * ddeg))*RC);

		dLsq = dL / SL;
		dCsq = dC / SC;
		dHsq = dH / SH;

		RCH = RT * dCsq * dHsq;

		dLsq *= dLsq;
		dCsq *= dCsq;
		dHsq *= dHsq;

		dsq = dLsq + dCsq + dHsq + RCH;
	}

	return dsq;

}


/* Spectral Functions ***********************************************************************************/

int corGetCIExyfromLambda(float lambda, float* x, float* y) {
	float x_bar, y_bar, z_bar;
	if (corGetCMFCIExyz(lambda, &x_bar, &y_bar, &z_bar)) {
		*x = x_bar / (x_bar + y_bar + z_bar);  /* Cromaticity coord.  */
		*y = y_bar / (x_bar + y_bar + z_bar);
		return 1;
	}
	else
		return 0;
}


int corCIEXYZfromReflectance401(float reflectance[401], float* X, float* Y, float* Z, int reference_light)
{
	float sum_x = 0, sum_y = 0, sum_z = 0, sum_w = 0;
	float lambda;

	for (lambda = 380; lambda<780; lambda += 1) {
		float Lw = corGetIllum(lambda, reference_light);
		float betha = reflectance[(int)lambda - 380];
		float x_bar, y_bar, z_bar;
		corGetCMFCIExyz(lambda, &x_bar, &y_bar, &z_bar);
		sum_x += Lw*betha*x_bar;
		sum_y += Lw*betha*y_bar;
		sum_z += Lw*betha*z_bar;
		sum_w += Lw*y_bar;
	}
	*X = sum_x / sum_w;
	*Y = sum_y / sum_w;
	*Z = sum_z / sum_w;
	return 1;
}

static float getFunctionValue(float x, float xmin, int npoints, float delta_x, float* yv)
{
	float xmax = xmin + (npoints - 1)*delta_x;
	float y = 0;
	if (x >= xmin && x <= xmax) {
		int i = (int)floor((x - xmin) / delta_x);
		float r = (x - (xmin + i*delta_x)) / delta_x;
		if (i == npoints - 1)
			y = yv[i];
		else
			y = (1 - r)*yv[i] + r*yv[i + 1];
	}
	return y;
}

int corCIEXYZfromSurfaceReflectance(float lambda_min, int n_points, float delta_lambda, float* reflectance, float* X, float* Y, float* Z, int reference_light)
{
	float sum_x = 0, sum_y = 0, sum_z = 0, sum_w = 0;
	float lambda, lambda_max = lambda_min + (n_points - 1)*delta_lambda;

	for (lambda = lambda_min; lambda<lambda_max; lambda += 1) {
		float Lw = corGetIllum(lambda, reference_light);
		float betha = getFunctionValue(lambda, lambda_min, n_points, delta_lambda, reflectance);
		float x_bar, y_bar, z_bar;
		corGetCMFCIExyz(lambda, &x_bar, &y_bar, &z_bar);
		sum_x += Lw*betha*x_bar;
		sum_y += Lw*betha*y_bar;
		sum_z += Lw*betha*z_bar;
		sum_w += Lw*y_bar;
	}
	*X = sum_x / sum_w;
	*Y = sum_y / sum_w;
	*Z = sum_z / sum_w;
	return 1;
}





static int index(float x) {
	return (int)(x - 380);
}

static int next(int i) {
	return (i != 400) ? i + 1 : 0;
}

static int previous(int i) {
	return (i != 0) ? i - 1 : 400;
}

/* Computes the most saturated CIE XYZ color from an spectrum centred at lambda_bar that has the luminance Y_bar */
int getCIEXYZGamutBorder(float Y_bar, float lambda_bar, float* X, float* Y, float* Z, float* betha, int reference_light)
{
	float sumVector[401]; //,betha[401];
	float sum;
	int   beginIndex, middleIndex, endIndex;

	float lambda, targetArea, deltaArea, factor;
	float sum_total, sum_x, sum_y, sum_z;
	float x_bar, y_bar, z_bar;
	float kw;
	float Xw = reference_white[reference_light][0];
	float Yw = reference_white[reference_light][1];
	float Zw = reference_white[reference_light][2];
	int i;

	for (i = 0; i<401; i++) betha[i] = 0;
	if (Y_bar<0.001) { *X = 0; *Y = 0; *Z = 0; return 0; }

	sum_x = sum_y = sum_z = sum_total = 0;
	for (lambda = 380; lambda <= 780; lambda += 1) {
		float Lw = corGetIllum(lambda, reference_light);
		i = index(lambda);
		x_bar = spec[i].x_bar;
		y_bar = spec[i].y_bar;
		z_bar = spec[i].z_bar;
		sumVector[i] = Lw*(Xw*x_bar + Yw*y_bar + Zw*z_bar);
		sum_total += sumVector[i];
		sum_x += Lw*x_bar; sum_y += Lw*y_bar; sum_z += Lw*z_bar;
		betha[i] = 0;
	}

	kw = 1 / sum_y;  Xw = kw*sum_x; Yw = 1; Zw = kw*sum_z;
	targetArea = Y_bar*(Xw*Xw + Yw*Yw + Zw*Zw) / kw;

	if (fabs((targetArea - Y_bar*sum_total) / targetArea)>0.01) {
		printf("targetArea = %f != area = %f\n", targetArea, Y_bar*sum_total);
		printf("Xw = %f %f Yw=%f  %f  Zw = %f  %f\n", Xw, sum_x / sum_y, Yw, sum_y / sum_y, Zw, sum_z / sum_y);
		exit(1);
	}

	middleIndex = index(lambda_bar);
	betha[middleIndex] = 1;
	sum = sumVector[middleIndex];
	beginIndex = middleIndex;
	endIndex = middleIndex;

	if (sum >= targetArea) {  /* areas muito pequenas, espectro de um ponto */
		betha[middleIndex] = targetArea / sum;
		sum = betha[middleIndex] * sumVector[middleIndex];
	}
	else {
		while (sum<targetArea) {
			beginIndex = previous(beginIndex);
			endIndex = next(endIndex);
			if (beginIndex == middleIndex || endIndex == middleIndex) {
				printf("Erro: *** utilizou a area toda e nao alcancou o alvo\n");
				exit(1);
			}
			deltaArea = sumVector[beginIndex] + sumVector[endIndex];
			sum += deltaArea;
			betha[beginIndex] = 1;
			betha[endIndex] = 1;
		}
		/* adjust difference with end points */
		sum -= deltaArea;
		factor = (targetArea - sum) / deltaArea;
		betha[beginIndex] = factor;
		betha[endIndex] = factor;
		sum += betha[beginIndex] * sumVector[beginIndex] + betha[endIndex] * sumVector[endIndex];
		if (fabs(sum - targetArea)>0.001) {
			printf("**ERRO: Area=%f != Target Area=%f\n", sum, targetArea);
			exit(1);
		}
	}

	sum_x = sum_y = sum_z = 0;
	for (lambda = 380; lambda <= 780; lambda += 1) {
		float Lw = corGetIllum(lambda, reference_light);
		i = index(lambda);
		sum_x += Lw*betha[i] * spec[i].x_bar;
		sum_y += Lw*betha[i] * spec[i].y_bar;
		sum_z += Lw*betha[i] * spec[i].z_bar;
	}
	*X = kw*sum_x;
	*Y = kw*sum_y;
	*Z = kw*sum_z;

	return 0;
}

/* UNTESTED */
/*int XYZtoCIE_Luv(double x, double y, double z, double* L, double* u, double* v, char ObsIll)
{
double ref_X = _ccTristimulusValues[ObsIll][ccX];
double ref_Y = _ccTristimulusValues[ObsIll][ccY];
double ref_Z = _ccTristimulusValues[ObsIll][ccZ];

double ref_U = ( 4 * ref_X ) / ( ref_X + ( 15 * ref_Y ) + ( 3 * ref_Z ) );
double ref_V = ( 9 * ref_Y ) / ( ref_X + ( 15 * ref_Y ) + ( 3 * ref_Z ) );

double var_U = ( 4 * x ) / ( x + ( 15 * y ) + ( 3 * z ) );
double var_V = ( 9 * y ) / ( x + ( 15 * y ) + ( 3 * z ) );
double var_Y = y / 100;


if ( var_Y > 0.008856 ) var_Y = pow(var_Y,( 1/3 ));
else                    var_Y = ( 7.787 * var_Y ) + ( 16 / 116 );


*L = ( 116 * var_Y ) - 16;
*u = 13 * *L * ( var_U - ref_U );
*v = 13 * *L * ( var_V - ref_V );

return 1;
}

int CIE_LuvtoXYZ(double L, double u, double v, double* x, double* y, double* z, char ObsIll)
{
double ref_X = _ccTristimulusValues[ObsIll][ccX];
double ref_Y = _ccTristimulusValues[ObsIll][ccY];
double ref_Z = _ccTristimulusValues[ObsIll][ccZ];

double ref_U = ( 4 * ref_X ) / ( ref_X + ( 15 * ref_Y ) + ( 3 * ref_Z ) );
double ref_V = ( 9 * ref_Y ) / ( ref_X + ( 15 * ref_Y ) + ( 3 * ref_Z ) );

double var_U = u / ( 13 * L ) + ref_U;
double var_V = v / ( 13 * L ) + ref_V;

double var_Y = ( L + 16 ) / 116;

if ( pow(var_Y,3) > 0.008856 ) var_Y = pow(var_Y,3);
else                      var_Y = ( var_Y - 16 / 116 ) / 7.787;

(*y) = var_Y * 100;
(*x) =  - ( 9 * *y * var_U ) / ( ( var_U - 4 ) * var_V  - var_U * var_V );
(*z) = ( 9 * *y - ( 15 * var_V * *y ) - ( var_V * *x ) ) / ( 3 * var_V );

return 1;
}*/



#undef RAD2DEG
#undef DEG2RAD
